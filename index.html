<html>
	<head>
		<title>COwin check</title>
		<script type="text/javascript"></script>
	</head>
	<form>
		<label>pincode</label>
		<input type="number" name="pincode" required="">
		<label>Time Interval(in second)</label>
		<input type="number" name="timeout" value=120>
		<label>No of weeks</label>
		<input type="number" name="nweeks" value=2>
		<input type="submit" name="submit">
	</form>
	<div>
	</div>
	<script type="text/javascript">
		if (Notification.permission !== "granted")
			Notification.requestPermission()
		form = document.forms[0]
		form.addEventListener('submit', (ev) => {
			ev.preventDefault()
			form['submit'].disabled = true;
			pin = form['pincode'].value
			time = form['timeout'].value
			nweeks = form['nweeks'].value

			options = {day: '2-digit', month: '2-digit', year: 'numeric'}
			setTimeout(() => {
				let date = new Date() 
				console.log(date)
				for(let i=0; i < nweeks; i++) {
					future = new Date(date.getTime() + (i * 7 * 24 * 3600000))
					future = future.toLocaleDateString('en-IN', options).split('/').join('-')
					console.log(`checking for 1 week from ${future}`)
					let xhttp = new XMLHttpRequest()
					xhttp.open('GET', `https://cdn-api.co-vin.in/api/v2/appointment/sessions/calendarByPin?pincode=${pin}&date=${future}`)
					xhttp.onreadystatechange = function () {
						if (this.readyState == 4 && this.status == 200) {
							data =  this.responseText;
							data = JSON.parse(data)
							available = 0
							div = document.querySelector('div')
							div.innerHTML = ""
							for (let center of data['centers']) {
								for (let sessions of center['sessions']) {
									if (sessions['available_capacity'] == 0) {
										div.insertAdjacentHTML('beforeend', `<div>${sessions['available_capacity']} slots avilable on ${sessions['date']} at ${center['name']} for ${sessions['vaccine']}</div>`)
										available += sessions['available_capacity']
									}
								}
							}
							new Notification("Slots available")
							if (available > 0) {
								new Notification("Slots available")
							}
						} else if (this.readyState == 4 && this.status != 200) {
							console.log("Server return erro code " + this.status);
						}
					}
					xhttp.send()
				}
			}, time * 1000)
		});
	</script>
</html>
